{% extends "base.html" %}

{% block title %}HDFC Bank Sync | Finance AI Assistant{% endblock %}

{% block extra_css %}
<style>
    body { background: #f5f7fa; }
    .main-container { max-width: 1000px; margin: 40px auto; padding: 0 20px; }
    .card { border: none; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .card-header { background: linear-gradient(135deg, #004c8c 0%, #006bb3 100%); color: white; border-radius: 15px 15px 0 0 !important; padding: 20px; }
    .btn-hdfc { background: #004c8c; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 600; }
    .btn-hdfc:hover { background: #003d70; color: white; }
    .status-badge { padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; }
    .status-connected { background: #d4edda; color: #155724; }
    .status-disconnected { background: #f8d7da; color: #721c24; }
    .setup-step { background: white; padding: 25px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #004c8c; }
    .setup-step h5 { color: #004c8c; margin-bottom: 15px; }
    .sync-stats { display: flex; justify-content: space-around; padding: 20px 0; }
    .stat-box { text-align: center; }
    .stat-box .number { font-size: 2.5rem; font-weight: bold; color: #004c8c; }
    .stat-box .label { color: #6c757d; font-size: 0.9rem; }
    .alert-info { background: #e7f3ff; border: 1px solid #b3d9ff; color: #004085; }
    .code-block { background: #f4f4f4; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9rem; overflow-x: auto; }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    
    <!-- Header -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-1"><i class="bi bi-bank"></i> HDFC Bank Email Sync</h3>
                    <p class="mb-0">Automatically import transactions from HDFC email alerts</p>
                </div>
                <div id="connectionStatus">
                    <span class="status-badge status-disconnected">
                        <i class="bi bi-circle-fill"></i> Disconnected
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Card -->
    <div class="card" id="statusCard" style="display: none;">
        <div class="card-body">
            <h5><i class="bi bi-info-circle"></i> Sync Status</h5>
            <div class="sync-stats">
                <div class="stat-box">
                    <div class="number" id="totalSynced">0</div>
                    <div class="label">Total Synced</div>
                </div>
                <div class="stat-box">
                    <div class="number" id="lastSync">Never</div>
                    <div class="label">Last Sync</div>
                </div>
                <div class="stat-box">
                    <div class="number" id="emailConnected">-</div>
                    <div class="label">Connected Email</div>
                </div>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-hdfc" onclick="syncNow()">
                    <i class="bi bi-arrow-repeat"></i> Sync Now
                </button>
                <button class="btn btn-outline-danger ms-2" onclick="disconnect()">
                    <i class="bi bi-x-circle"></i> Disconnect
                </button>
            </div>
        </div>
    </div>

    <!-- Setup Guide -->
    <div class="card" id="setupCard">
        <div class="card-body">
            <h4 class="mb-4"><i class="bi bi-gear"></i> Setup Guide</h4>

            <!-- Step 1 -->
            <div class="setup-step">
                <h5><i class="bi bi-1-circle-fill"></i> Enable Gmail App Password</h5>
                <p>For security, Google requires an "App Password" instead of your regular password.</p>
                <ol>
                    <li>Go to <a href="https://myaccount.google.com/security" target="_blank">Google Account Security</a></li>
                    <li>Enable <strong>2-Step Verification</strong> (if not already enabled)</li>
                    <li>Go to <strong>App Passwords</strong> section</li>
                    <li>Select <strong>Mail</strong> and <strong>Other (Custom name)</strong></li>
                    <li>Enter "Expense Tracker" and click <strong>Generate</strong></li>
                    <li>Copy the 16-character password (looks like: <code>abcd efgh ijkl mnop</code>)</li>
                </ol>
                <div class="alert alert-info">
                    <i class="bi bi-shield-check"></i> <strong>Security Note:</strong> App passwords are safer than your main password and can be revoked anytime.
                </div>
            </div>

            <!-- Step 2 -->
            <div class="setup-step">
                <h5><i class="bi bi-2-circle-fill"></i> Connect Your Email</h5>
                <p>Enter your Gmail address and the app password you generated:</p>
                
                <form id="connectForm" onsubmit="connectEmail(event)">
                    <div class="mb-3">
                        <label class="form-label">Gmail Address</label>
                        <input type="email" class="form-control" id="emailAddress" placeholder="your.email@gmail.com" required>
                        <small class="text-muted">The Gmail where you receive HDFC alerts</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">App Password</label>
                        <input type="password" class="form-control" id="appPassword" placeholder="16-character app password" required>
                        <small class="text-muted">Remove spaces: abcdefghijklmnop</small>
                    </div>

                    <button type="submit" class="btn btn-hdfc">
                        <i class="bi bi-link-45deg"></i> Connect Email
                    </button>
                </form>
            </div>

            <!-- Step 3 -->
            <div class="setup-step">
                <h5><i class="bi bi-3-circle-fill"></i> How It Works</h5>
                <ul>
                    <li><strong>Automatic Detection:</strong> Finds all HDFC transaction alert emails</li>
                    <li><strong>Smart Parsing:</strong> Extracts amount, vendor, date, payment method</li>
                    <li><strong>AI Categorization:</strong> Automatically categorizes transactions</li>
                    <li><strong>Duplicate Prevention:</strong> Skips transactions already in your database</li>
                    <li><strong>Budget Sync:</strong> Automatically updates your budgets</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Sync Results -->
    <div class="card" id="resultsCard" style="display: none;">
        <div class="card-body">
            <h5><i class="bi bi-check-circle"></i> Sync Results</h5>
            <div id="syncResults"></div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
<script>

// Check connection status on page load
document.addEventListener('DOMContentLoaded', function() {
    checkStatus();
});

async function checkStatus() {
    try {
        const response = await fetch('/hdfc/status');
        const data = await response.json();
        
        if (data.success && data.is_connected) {
            showConnectedState(data);
        } else {
            showDisconnectedState();
        }
    } catch (error) {
        console.error('Status check failed:', error);
    }
}

function showConnectedState(data) {
    document.getElementById('setupCard').style.display = 'none';
    document.getElementById('statusCard').style.display = 'block';
    
    // Update status badge
    const statusBadge = document.querySelector('#connectionStatus .status-badge');
    statusBadge.className = 'status-badge status-connected';
    statusBadge.innerHTML = '<i class="bi bi-circle-fill"></i> Connected';
    
    // Update stats
    document.getElementById('totalSynced').textContent = data.total_synced || 0;
    document.getElementById('emailConnected').textContent = data.email || '-';
    
    if (data.last_sync) {
        const lastSyncDate = new Date(data.last_sync);
        document.getElementById('lastSync').textContent = lastSyncDate.toLocaleString();
    }
}

function showDisconnectedState() {
    document.getElementById('setupCard').style.display = 'block';
    document.getElementById('statusCard').style.display = 'none';
    
    const statusBadge = document.querySelector('#connectionStatus .status-badge');
    statusBadge.className = 'status-badge status-disconnected';
    statusBadge.innerHTML = '<i class="bi bi-circle-fill"></i> Disconnected';
}

async function connectEmail(event) {
    event.preventDefault();
    
    const emailAddress = document.getElementById('emailAddress').value.trim();
    const appPassword = document.getElementById('appPassword').value.replace(/\s/g, '');
    
    const btn = event.target.querySelector('button');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Connecting...';
    
    try {
        const response = await fetch('/hdfc/connect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email_address: emailAddress, app_password: appPassword })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('✅ Email connected successfully!\n\nClick "Sync Now" to import transactions.');
            checkStatus();
        } else {
            alert('❌ Connection failed: ' + data.error);
        }
    } catch (error) {
        alert('❌ Error: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-link-45deg"></i> Connect Email';
    }
}

async function syncNow() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Syncing...';
    
    try {
        const response = await fetch('/hdfc/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ days_back: 30 })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSyncResults(data);
            checkStatus();
        } else {
            alert('❌ Sync failed: ' + data.error);
        }
    } catch (error) {
        alert('❌ Error: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Sync Now';
    }
}

function showSyncResults(data) {
    const resultsCard = document.getElementById('resultsCard');
    const resultsDiv = document.getElementById('syncResults');
    
    const stats = data.stats;
    
    resultsDiv.innerHTML = `
        <div class="alert alert-success">
            <h6><i class="bi bi-check-circle"></i> Sync Complete!</h6>
            <ul class="mb-0">
                <li><strong>Total Found:</strong> ${stats.total}</li>
                <li><strong>Added:</strong> ${stats.added}</li>
                <li><strong>Duplicates Skipped:</strong> ${stats.duplicates}</li>
                <li><strong>Errors:</strong> ${stats.errors}</li>
            </ul>
            ${stats.error_details && stats.error_details.length > 0 ? `
                <hr>
                <small><strong>Errors:</strong><br>${stats.error_details.join('<br>')}</small>
            ` : ''}
        </div>
    `;
    
    resultsCard.style.display = 'block';
    
    setTimeout(() => {
        resultsCard.style.display = 'none';
    }, 10000);
}

async function disconnect() {
    if (!confirm('Are you sure you want to disconnect HDFC email sync?')) return;
    
    try {
        const response = await fetch('/hdfc/disconnect', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            alert('✅ Email disconnected');
            checkStatus();
        }
    } catch (error) {
        alert('❌ Error: ' + error.message);
    }
}

</script>
{% endblock %}